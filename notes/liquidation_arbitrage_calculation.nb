(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 13.2' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[     25186,        696]
NotebookOptionsPosition[     23173,        658]
NotebookOutlinePosition[     23578,        674]
CellTagsIndexPosition[     23535,        671]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{
Cell[TextData[Cell[BoxData[{
 FormBox[
  RowBox[{
   RowBox[{
    StyleBox[
     SubscriptBox["dex", "1"],
     FontWeight->"Bold"], 
    StyleBox[" ",
     FontWeight->"Bold"], "is", " ", "v2"}], "-", 
   RowBox[{
   "uniswap", " ", "between", " ", "vault", " ", "collateral", " ", "and", 
    " ", "f"}], "-", "asset"}], TraditionalForm], "\[IndentingNewLine]", 
 FormBox[
  RowBox[{
   RowBox[{
    StyleBox[
     SubscriptBox["dex", "2"],
     FontWeight->"Bold"], " ", "is", " ", "v2"}], "-", 
   RowBox[{
   "uniswap", " ", "between", " ", "pool", " ", "collateral", " ", "and", " ",
     "vault", " ", "collateral"}]}], TraditionalForm], "\[IndentingNewLine]", 
 FormBox[
  RowBox[{
   StyleBox[
    SubscriptBox["V", 
     SubscriptBox["dex", "1"]],
    FontWeight->"Bold"], " ", "is", " ", "vault", " ", "collateral", " ", 
   "reserve", " ", "of", " ", 
   SubscriptBox["dex", "1"]}], TraditionalForm], "\[IndentingNewLine]", 
 FormBox[
  RowBox[{
   RowBox[{
    StyleBox[
     SubscriptBox["F", 
      SubscriptBox["dex", "1"]],
     FontWeight->"Bold"], " ", "is", " ", "f"}], "-", 
   RowBox[{"asset", " ", "reserve", " ", "of", " ", 
    SubscriptBox["dex", "1"]}]}], TraditionalForm], "\[IndentingNewLine]", 
 FormBox[
  RowBox[{
   StyleBox[
    SubscriptBox["W", 
     SubscriptBox["dex", "2"]],
    FontWeight->"Bold"], " ", "is", " ", "pool", " ", "collateral", " ", 
   "reserve", " ", "of", " ", 
   SubscriptBox["dex", "2"]}], TraditionalForm], "\[IndentingNewLine]", 
 FormBox[
  RowBox[{
   StyleBox[
    SubscriptBox["V", 
     SubscriptBox["dex", "2"]],
    FontWeight->"Bold"], " ", "is", " ", "vault", " ", "collateral", " ", 
   "reserve", " ", "of", " ", 
   SubscriptBox["dex", "2"]}], TraditionalForm], "\[IndentingNewLine]", 
 FormBox[
  RowBox[{
   RowBox[{
    StyleBox[
     SubscriptBox["Price", "V"],
     FontWeight->"Bold"], " ", "is", " ", "price", " ", "of", " ", "f"}], "-", 
   RowBox[{
   "asset", " ", "in", " ", "vault", " ", "collateral", " ", "on", " ", 
    "flare", " ", "ftso"}]}], TraditionalForm], "\[IndentingNewLine]", 
 FormBox[
  RowBox[{
   RowBox[{
    StyleBox[
     SubscriptBox["Price", "W"],
     FontWeight->"Bold"], " ", "is", " ", "price", " ", "of", " ", "f"}], "-", 
   RowBox[{
   "asset", " ", "in", " ", "native", " ", "currency", " ", "on", " ", 
    "flare", " ", "ftso"}]}], TraditionalForm], "\[IndentingNewLine]", 
 FormBox[
  RowBox[{
   StyleBox[
    SubscriptBox["LFactor", 
     RowBox[{"V", " "}]],
    FontWeight->"Bold"], " ", "is", " ", "vault", " ", "collateral", " ", 
   "liquidation", " ", "reward", " ", "factor"}], 
  TraditionalForm], "\[IndentingNewLine]", 
 FormBox[
  RowBox[{
   StyleBox[
    SubscriptBox["LFactor", "W"],
    FontWeight->"Bold"], " ", "is", " ", "pool", " ", "collateral", " ", 
   "liquidation", " ", "reward", " ", "factor"}], 
  TraditionalForm], "\[IndentingNewLine]", 
 FormBox[
  RowBox[{
   StyleBox[
    SubscriptBox["\[Rho]", 
     SubscriptBox["dex", 
      RowBox[{"1", " "}]]],
    FontWeight->"Bold"], " ", "is", " ", "the", " ", "fee", " ", "factor", 
   " ", "of", " ", 
   SubscriptBox["dex", "1"]}], TraditionalForm], "\[IndentingNewLine]", 
 FormBox[
  RowBox[{
   RowBox[{
    StyleBox[
     SubscriptBox["\[Rho]", 
      SubscriptBox["dex", 
       RowBox[{"2", " "}]]],
     FontWeight->"Bold"], " ", "is", " ", "the", " ", "fee", " ", "factor", 
    " ", "of", " ", 
    SubscriptBox["dex", "2"]}], "\[IndentingNewLine]"}], 
  TraditionalForm], "\[IndentingNewLine]", 
 FormBox[
  RowBox[{
   RowBox[{"Note", " ", "that", " ", "swap", " ", "for", " ", 
    SubscriptBox["dex", "2"], " ", "the", " ", "calculation", " ", "is", " ", 
    "too", " ", "complex"}], ",", " ", 
   RowBox[{
   "so", " ", "we", " ", "simplify", " ", "it", " ", "by", " ", "not", " ", 
    "accounting", " ", "for", " ", 
    RowBox[{"slippage", ".", " ", "It"}], " ", "should", " ", "not", " ", 
    "matter", " ", "too", " ", "much", " ", "if", " ", "dex", " ", "has", " ",
     "enough", " ", "pool", " ", "collateral", " ", 
    RowBox[{"reserves", "."}]}]}], 
  TraditionalForm]}],ExpressionUUID->"765700ab-2a5c-4f09-aafb-9d81db3394d6"]],\
 "Text",
 CellChangeTimes->{{3.9031162932208633`*^9, 3.9031165967534885`*^9}, {
  3.903116632351318*^9, 3.9031166757424326`*^9}, {3.903116763869707*^9, 
  3.9031167768758254`*^9}, {3.9031168170273476`*^9, 3.90311689099265*^9}, {
  3.9031555049727545`*^9, 3.903155548108878*^9}, {3.9031866633414364`*^9, 
  3.9031866641029034`*^9}, {3.9031886974162416`*^9, 3.903188702130861*^9}, {
  3.9032882602540073`*^9, 3.9032882607777987`*^9}, {3.9035341046356077`*^9, 
  3.9035341053456373`*^9}, {3.9035348458095245`*^9, 
  3.90353489444337*^9}},ExpressionUUID->"82180e06-fd4d-4c7d-9a35-\
692622d2af33"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    SubscriptBox["Swap", 
     RowBox[{
      SubscriptBox["dex", "1"], "F"}]], "[", "v_", "]"}], " ", ":=", " ", 
   RowBox[{
    SubscriptBox["\[Rho]", 
     SubscriptBox["dex", "1"]], " ", "v", " ", 
    RowBox[{
     SubscriptBox["F", 
      SubscriptBox["dex", "1"]], " ", "/", " ", 
     RowBox[{"(", 
      RowBox[{
       SubscriptBox["V", 
        SubscriptBox["dex", "1"]], " ", "+", " ", 
       RowBox[{"v", " ", 
        SubscriptBox["\[Rho]", 
         SubscriptBox["dex", "1"]]}]}], ")"}]}]}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    SubscriptBox["Swap", 
     RowBox[{
      SubscriptBox["dex", "2"], "V"}]], "[", "w_", "]"}], " ", ":=", " ", 
   RowBox[{
    SubscriptBox["\[Rho]", 
     SubscriptBox["dex", "2"]], " ", "w", " ", 
    RowBox[{
     SubscriptBox["V", 
      SubscriptBox["dex", "2"]], " ", "/", " ", 
     SubscriptBox["W", 
      SubscriptBox["dex", "2"]]}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    SubscriptBox["Liquidate", "V"], "[", "f_", "]"}], " ", ":=", " ", 
   RowBox[{"f", " ", 
    SubscriptBox["Price", "V"], " ", 
    SubscriptBox["LFactor", "V"]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    SubscriptBox["Liquidate", "W"], "[", "f_", "]"}], " ", ":=", " ", 
   RowBox[{"f", " ", 
    SubscriptBox["Price", "w"], " ", 
    SubscriptBox["LFactor", "W"]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Arbitrage", "[", "v_", "]"}], ":=", " ", 
   RowBox[{
    RowBox[{
     SubscriptBox["Liquidate", "V"], "[", 
     RowBox[{
      SubscriptBox["Swap", 
       RowBox[{
        SubscriptBox["dex", "1"], "F"}]], "[", "v", "]"}], "]"}], " ", "+", 
    " ", 
    RowBox[{
     SubscriptBox["Swap", 
      RowBox[{
       SubscriptBox["dex", "2"], "V"}]], "[", 
     RowBox[{
      SubscriptBox["Liquidate", "W"], "[", 
      RowBox[{
       SubscriptBox["Swap", 
        RowBox[{
         SubscriptBox["dex", "1"], "F"}]], "[", "v", "]"}], "]"}], "]"}], " ",
     "-", " ", "v"}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.902900895257979*^9, 3.902900936497165*^9}, {
   3.9029087652447534`*^9, 3.902908765878471*^9}, {3.9029090714134893`*^9, 
   3.9029090840445995`*^9}, {3.9029102676356955`*^9, 3.902910287955145*^9}, {
   3.9029880436547117`*^9, 3.9029880537501173`*^9}, {3.9029979391088014`*^9, 
   3.9029980150568466`*^9}, {3.903114456276924*^9, 3.9031151378385763`*^9}, {
   3.90311517401068*^9, 3.90311589900215*^9}, {3.903115965679291*^9, 
   3.9031159749348297`*^9}, {3.903116034102171*^9, 3.903116034138297*^9}, {
   3.9031161173262978`*^9, 3.90311611737197*^9}, {3.9031162805644608`*^9, 
   3.9031162817036*^9}, {3.9031555651839767`*^9, 3.9031555661168213`*^9}, 
   3.9031855871705465`*^9, {3.9031877967404647`*^9, 3.903187797941474*^9}, {
   3.903189342212657*^9, 3.903189343390143*^9}, {3.903288273033044*^9, 
   3.9032882920349503`*^9}, 3.90353410668419*^9, {3.9040503973572197`*^9, 
   3.9040504096425314`*^9}},ExpressionUUID->"f709db59-644d-46b1-9390-\
c93ac5c9cb4c"],

Cell["There are two extremes, only one can be positive", "Text",
 CellChangeTimes->{{3.903116806425336*^9, 3.9031168151753635`*^9}, {
  3.9031169264480295`*^9, 3.9031169358318863`*^9}, {3.9031555952941055`*^9, 
  3.903155595626266*^9}},ExpressionUUID->"f0513101-83d3-439f-8bab-\
ef380286ecdc"],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{
  RowBox[{"extremes", "=", " ", 
   RowBox[{"Solve", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"D", "[", 
       RowBox[{
        RowBox[{"Arbitrage", "[", "x", "]"}], ",", " ", "x"}], "]"}], " ", "==",
       " ", "0"}], ",", " ", "x"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Arbitrage", "[", "x", "]"}], " ", "/.", " ", 
    RowBox[{"extremes", "[", 
     RowBox[{"[", "1", "]"}], "]"}]}], " ", "//", " ", "FullSimplify"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Arbitrage", "[", "x", "]"}], " ", "/.", " ", 
    RowBox[{"extremes", "[", 
     RowBox[{"[", "2", "]"}], "]"}]}], " ", "//", " ", "FullSimplify"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  SubscriptBox["v", "o"], " ", "=", 
  RowBox[{
   RowBox[{"x", " ", "/.", " ", 
    RowBox[{"extremes", "[", 
     RowBox[{"[", "2", "]"}], "]"}]}], " ", "//", " ", 
   "FullSimplify"}]}]}], "Input",
 CellChangeTimes->{{3.902900895257979*^9, 3.902900936497165*^9}, {
   3.9029087652447534`*^9, 3.902908765878471*^9}, {3.9029090714134893`*^9, 
   3.9029090840445995`*^9}, {3.9029102676356955`*^9, 3.902910287955145*^9}, {
   3.9029880436547117`*^9, 3.9029880537501173`*^9}, {3.9029979391088014`*^9, 
   3.9029980150568466`*^9}, {3.903114456276924*^9, 3.9031151378385763`*^9}, {
   3.90311517401068*^9, 3.903115927121336*^9}, {3.9031159818961945`*^9, 
   3.903115989609868*^9}, {3.9031160241139326`*^9, 3.9031160395035944`*^9}, {
   3.903116132917425*^9, 3.9031162208215218`*^9}, {3.903116251625409*^9, 
   3.9031162738677907`*^9}, {3.903184247448305*^9, 3.903184248093546*^9}, {
   3.903189346997063*^9, 3.903189351231183*^9}, {3.9032883145789056`*^9, 
   3.9032883163657885`*^9}, {3.903344173270087*^9, 3.9033442334211783`*^9}, 
   3.903349387909893*^9, {3.9033494350768275`*^9, 3.9033494480111914`*^9}, {
   3.9035341130064125`*^9, 3.903534115636026*^9}, {3.904050718563637*^9, 
   3.904050747164607*^9}, {3.9040508127785673`*^9, 3.9040508517276287`*^9}},
 CellLabel->"In[46]:=",ExpressionUUID->"4bcf5699-246b-4407-a012-fa42f83d9e93"],

Cell[BoxData[
 FractionBox[
  RowBox[{
   RowBox[{
    RowBox[{"-", 
     SubscriptBox["V", 
      SubscriptBox["dex", "1"]]}], " ", 
    SubscriptBox["\[Rho]", 
     SubscriptBox["dex", "1"]]}], "+", 
   FractionBox[
    SqrtBox[
     RowBox[{
      SubscriptBox["F", 
       SubscriptBox["dex", "1"]], " ", 
      SubscriptBox["V", 
       SubscriptBox["dex", "1"]], " ", 
      SubscriptBox["W", 
       SubscriptBox["dex", "2"]], " ", 
      SubsuperscriptBox["\[Rho]", 
       SubscriptBox["dex", "1"], "3"], " ", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{
         SubscriptBox["LFactor", "V"], " ", 
         SubscriptBox["Price", "V"], " ", 
         SubscriptBox["W", 
          SubscriptBox["dex", "2"]]}], "+", 
        RowBox[{
         SubscriptBox["LFactor", "W"], " ", 
         SubscriptBox["Price", "w"], " ", 
         SubscriptBox["V", 
          SubscriptBox["dex", "2"]], " ", 
         SubscriptBox["\[Rho]", 
          SubscriptBox["dex", "2"]]}]}], ")"}]}]], 
    SubscriptBox["W", 
     SubscriptBox["dex", "2"]]]}], 
  SubsuperscriptBox["\[Rho]", 
   SubscriptBox["dex", "1"], "2"]]], "Output",
 CellChangeTimes->{
  3.9031158776783047`*^9, {3.903115983228944*^9, 3.9031159898791637`*^9}, {
   3.9031160285391116`*^9, 3.903116047422891*^9}, {3.9031161254936447`*^9, 
   3.9031162218665476`*^9}, 3.903116253655942*^9, {3.9031842494906974`*^9, 
   3.903184255532901*^9}, 3.903185526945323*^9, 3.9031893557197523`*^9, {
   3.90328830048734*^9, 3.903288317337338*^9}, 3.9033461533002653`*^9, 
   3.9033494493777356`*^9, 3.9035341307281666`*^9, 3.9040129066148014`*^9, {
   3.9040507194192376`*^9, 3.904050747436431*^9}, {3.904050814636577*^9, 
   3.904050854811688*^9}},
 CellLabel->"Out[49]=",ExpressionUUID->"0568c3db-3595-44d9-bc92-d1ddb4880b68"]
}, Open  ]],

Cell[TextData[{
 "Note that that the tradeoff between avoiding 256-bit overflows and numeric \
errors made the calculation of the optimal vault collateral be implemented in \
the below order. In this way, we cap the numeric error at about ",
 Cell[BoxData[
  FormBox[
   SqrtBox[
    SubscriptBox["F", 
     SubscriptBox["dex", "1"]]], TraditionalForm]],
  FormatType->TraditionalForm,ExpressionUUID->
  "d01740ea-b78c-4b79-9982-d59733de2aaf"],
 " + ",
 Cell[BoxData[
  FormBox[
   SqrtBox[
    SubscriptBox["W", 
     SubscriptBox["dex", "2"]]], TraditionalForm]],
  FormatType->TraditionalForm,ExpressionUUID->
  "7c747010-c62b-4d06-b374-8d1d725ae4cc"],
 "."
}], "Text",
 CellChangeTimes->{{3.9031889559175625`*^9, 3.9031889661197834`*^9}, {
  3.903189227439418*^9, 3.9031892666858563`*^9}, {3.9031893643955493`*^9, 
  3.9031893693605413`*^9}, {3.903189490254855*^9, 3.9031895135994396`*^9}, {
  3.90318960500953*^9, 3.903189634751243*^9}, {3.9031899254401755`*^9, 
  3.903190019084835*^9}, {3.904012918949246*^9, 3.9040129460852146`*^9}, {
  3.9040129820777035`*^9, 3.9040130470931406`*^9}, {3.904051233395976*^9, 
  3.904051250831775*^9}},ExpressionUUID->"c538d92f-4980-44e9-9cc1-\
2f63826e0569"],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{
  RowBox[{"(", 
   RowBox[{
    RowBox[{
     RowBox[{"-", 
      SubscriptBox["V", 
       SubscriptBox["dex", "1"]]}], " ", 
     SubscriptBox["W", 
      SubscriptBox["dex", "2"]]}], " ", "+", " ", 
    RowBox[{
     RowBox[{"\[Sqrt]", 
      RowBox[{"(", 
       RowBox[{
        SubscriptBox["V", 
         SubscriptBox["dex", "1"]], " ", 
        SubscriptBox["W", 
         SubscriptBox["dex", "2"]], 
        SubscriptBox["\[Rho]", 
         SubscriptBox["dex", "1"]]}], ")"}]}], 
     RowBox[{"\[Sqrt]", 
      RowBox[{"(", 
       RowBox[{
        SubscriptBox["F", 
         SubscriptBox["dex", "1"]], " ", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{
           SubscriptBox["LFactor", "V"], 
           SubscriptBox["Price", "V"], 
           SubscriptBox["W", 
            SubscriptBox["dex", "2"]]}], " ", "+", " ", 
          RowBox[{
           SubscriptBox["LFactor", "W"], " ", 
           SubscriptBox["Price", "W"], " ", 
           SubscriptBox["V", 
            SubscriptBox["dex", "2"]], 
           SubscriptBox["\[Rho]", 
            SubscriptBox["dex", "2"]]}]}], ")"}]}], ")"}]}]}]}], ")"}], " ", 
  "/", " ", 
  RowBox[{"(", 
   RowBox[{
    SubscriptBox["W", 
     SubscriptBox["dex", "2"]], " ", 
    SubscriptBox["\[Rho]", 
     SubscriptBox["dex", "1"]]}], ")"}]}]], "Input",
 CellChangeTimes->{{3.9031889695572233`*^9, 3.9031891628044286`*^9}, {
  3.903189762688012*^9, 3.9031897651521015`*^9}},
 CellLabel->"In[10]:=",ExpressionUUID->"96f82651-58d8-4050-8cea-7e5a19e465ca"],

Cell[BoxData[
 FractionBox[
  RowBox[{
   RowBox[{
    RowBox[{"-", 
     SubscriptBox["V", 
      SubscriptBox["dex", "1"]]}], " ", 
    SubscriptBox["W", 
     SubscriptBox["dex", "2"]]}], "+", 
   RowBox[{
    SqrtBox[
     RowBox[{
      SubscriptBox["V", 
       SubscriptBox["dex", "1"]], " ", 
      SubscriptBox["W", 
       SubscriptBox["dex", "2"]], " ", 
      SubscriptBox["\[Rho]", 
       SubscriptBox["dex", "1"]]}]], " ", 
    SqrtBox[
     RowBox[{
      SubscriptBox["F", 
       SubscriptBox["dex", "1"]], " ", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{
         SubscriptBox["LFactor", "V"], " ", 
         SubscriptBox["Price", "V"], " ", 
         SubscriptBox["W", 
          SubscriptBox["dex", "2"]]}], "+", 
        RowBox[{
         SubscriptBox["LFactor", "W"], " ", 
         SubscriptBox["Price", "W"], " ", 
         SubscriptBox["V", 
          SubscriptBox["dex", "2"]], " ", 
         SubscriptBox["\[Rho]", 
          SubscriptBox["dex", "2"]]}]}], ")"}]}]]}]}], 
  RowBox[{
   SubscriptBox["W", 
    SubscriptBox["dex", "2"]], " ", 
   SubscriptBox["\[Rho]", 
    SubscriptBox["dex", "1"]]}]]], "Output",
 CellChangeTimes->{3.9031891653084545`*^9, 3.9031897663015213`*^9, 
  3.90353413259147*^9},
 CellLabel->"Out[10]=",ExpressionUUID->"425ff5c3-c020-4357-9a3c-d01afc4fa112"]
}, Open  ]],

Cell["\<\
In the end we have to cap this value by the vault collateral that gets \
swapped to max liquidation f-asset amount.\
\>", "Text",
 CellChangeTimes->{{3.903185481850884*^9, 
  3.903185515340127*^9}},ExpressionUUID->"4d0bd073-b434-4bc3-be11-\
6749ea372c2b"],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{
  SubscriptBox["max", "V"], " ", "=", " ", 
  RowBox[{
   RowBox[{
    RowBox[{"InverseFunction", "[", 
     SubscriptBox["Swap", 
      RowBox[{
       SubscriptBox["dex", "1"], "F"}]], "]"}], "[", 
    SubscriptBox["max", "F"], "]"}], " ", "//", " ", "Simplify"}]}]], "Input",
 CellChangeTimes->{{3.903185518429276*^9, 3.903185610530817*^9}, {
  3.903346139642687*^9, 3.9033461463671637`*^9}},
 CellLabel->"In[13]:=",ExpressionUUID->"d61f5898-1609-43d8-af28-189cb9d95e73"],

Cell[BoxData[
 FractionBox[
  RowBox[{
   SubscriptBox["max", "F"], " ", 
   SubscriptBox["V", 
    SubscriptBox["dex", "1"]]}], 
  RowBox[{
   RowBox[{"(", 
    RowBox[{
     SubscriptBox["F", 
      SubscriptBox["dex", "1"]], "-", 
     SubscriptBox["max", "F"]}], ")"}], " ", 
   SubscriptBox["\[Rho]", 
    SubscriptBox["dex", "1"]]}]]], "Output",
 CellChangeTimes->{{3.9031855797782927`*^9, 3.9031856109004593`*^9}, 
   3.9031893610208216`*^9, 3.90328832552211*^9, {3.9033461425650463`*^9, 
   3.903346156257043*^9}, 3.90353413928407*^9, 3.904012910239977*^9, 
   3.904013056300769*^9},
 CellLabel->"Out[13]=",ExpressionUUID->"6c0f0c31-c573-4576-998f-568058620d97"]
}, Open  ]],

Cell[TextData[{
 "Ideally, we want the chain conditions such that users profit the most by \
liquidating all the vault collateral that is needed to get an agent out of \
liquidation. This means we want Arbitrage to be maximized at a value larger \
or equal than ",
 Cell[BoxData[
  FormBox[
   SubscriptBox["max", "V"], TraditionalForm]],
  FormatType->TraditionalForm,ExpressionUUID->
  "534ec38c-eff7-4553-96c4-7a521122620c"],
 ". Below we vary the constants to see how market conditions affect this."
}], "Text",
 CellChangeTimes->{{3.9033427173149*^9, 3.903342785652141*^9}, {
  3.903342833178138*^9, 3.903342921332443*^9}, {3.9033429727866125`*^9, 
  3.903343063276394*^9}, {3.903349524837351*^9, 
  3.9033495265173364`*^9}},ExpressionUUID->"d5705be0-4844-4a4e-a7fb-\
6ea238ba3880"],

Cell[BoxData[
 RowBox[{"\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{
     SubscriptBox["max", "FV"], " ", "=", " ", 
     RowBox[{
      RowBox[{"(", 
       RowBox[{
        SubscriptBox["CR", "Vt"], " ", "-", " ", 
        SubscriptBox["CR", "V"]}], ")"}], " ", "/", " ", 
      RowBox[{"(", 
       RowBox[{
        SubscriptBox["CR", "Vt"], " ", "-", " ", 
        SubscriptBox["LFactor", "V"]}], ")"}]}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     SubscriptBox["max", "FW"], " ", "=", " ", 
     RowBox[{
      RowBox[{"(", 
       RowBox[{
        SubscriptBox["CR", "Wt"], " ", "-", " ", 
        SubscriptBox["CR", "W"]}], ")"}], " ", "/", " ", 
      RowBox[{"(", 
       RowBox[{
        SubscriptBox["CR", "Wt"], " ", "-", " ", 
        SubscriptBox["LFactor", "W"]}], ")"}]}]}], ";"}]}]}]], "Input",
 CellChangeTimes->{{3.903349528043397*^9, 3.9033495625196247`*^9}, {
  3.9034115828446264`*^9, 3.9034115935433865`*^9}, {3.9034116664520807`*^9, 
  3.9034117721383038`*^9}, {3.9034118737416773`*^9, 3.9034118755518904`*^9}, {
  3.903534016716197*^9, 3.903534025901966*^9}},
 CellLabel->"In[12]:=",ExpressionUUID->"362c6f00-edcd-4b29-a823-2c7020815984"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   SubscriptBox["max", "F"], " ", "=", " ", 
   RowBox[{"Max", "[", 
    RowBox[{"{", 
     RowBox[{
      SubscriptBox["max", "FV"], ",", " ", 
      SubscriptBox["max", "FW"]}], "}"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    SubscriptBox["used", "F"], " ", "=", " ", 
    RowBox[{"Arbitrage", "[", 
     SubscriptBox["v", "o"], "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"MAXRESERVES", " ", "=", " ", "1000000"}], ";"}]}], "Input",
 CellChangeTimes->{
  3.903411741021378*^9, 3.9034117759142556`*^9, {3.903411841675308*^9, 
   3.903411877699643*^9}, {3.903533606710981*^9, 3.903533642258732*^9}, {
   3.9035336752880955`*^9, 3.9035336795115857`*^9}, {3.9035337168363624`*^9, 
   3.9035337305123234`*^9}, {3.903533937656482*^9, 3.9035339399689703`*^9}},
 CellLabel->"In[14]:=",ExpressionUUID->"73b01958-8c1f-4508-87d1-11ecc34a002f"],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{
  RowBox[{
   SubscriptBox["v", "o"], " ", "==", " ", 
   SubscriptBox["max", "V"]}], " ", "//", " ", "FullSimplify"}]], "Input",
 CellChangeTimes->{{3.904012850352165*^9, 3.904012894331129*^9}, {
  3.904013062544389*^9, 3.904013064984751*^9}, {3.9040131091306047`*^9, 
  3.9040131097391024`*^9}},
 CellLabel->"In[16]:=",ExpressionUUID->"956468ae-d3b0-4b3e-92b2-01ac3aa70a80"],

Cell[BoxData[
 RowBox[{
  FractionBox[
   RowBox[{
    SubscriptBox["F", 
     SubscriptBox["dex", "1"]], " ", 
    SubscriptBox["V", 
     SubscriptBox["dex", "1"]]}], 
   RowBox[{
    SubscriptBox["F", 
     SubscriptBox["dex", "1"]], "-", 
    SubscriptBox["max", "F"]}]], "\[Equal]", 
  FractionBox[
   SqrtBox[
    RowBox[{
     SubscriptBox["F", 
      SubscriptBox["dex", "1"]], " ", 
     SubscriptBox["V", 
      SubscriptBox["dex", "1"]], " ", 
     SubscriptBox["W", 
      SubscriptBox["dex", "2"]], " ", 
     SubsuperscriptBox["\[Rho]", 
      SubscriptBox["dex", "1"], "3"], " ", 
     RowBox[{"(", 
      RowBox[{
       RowBox[{
        SubscriptBox["LFactor", "V"], " ", 
        SubscriptBox["Price", "V"], " ", 
        SubscriptBox["W", 
         SubscriptBox["dex", "2"]]}], "+", 
       RowBox[{
        SubscriptBox["LFactor", "W"], " ", 
        SubscriptBox["Price", "w"], " ", 
        SubscriptBox["V", 
         SubscriptBox["dex", "2"]], " ", 
        SubscriptBox["\[Rho]", 
         SubscriptBox["dex", "2"]]}]}], ")"}]}]], 
   RowBox[{
    SubscriptBox["W", 
     SubscriptBox["dex", "2"]], " ", 
    SubscriptBox["\[Rho]", 
     SubscriptBox["dex", "1"]]}]]}]], "Output",
 CellChangeTimes->{
  3.9040128949446383`*^9, {3.904013058923266*^9, 3.904013065842396*^9}, 
   3.904013110443373*^9},
 CellLabel->"Out[16]=",ExpressionUUID->"ea3261b0-4c97-4295-b6f2-d83971a6c275"]
}, Open  ]],

Cell[BoxData[""], "Input",
 CellChangeTimes->{{3.9040128766999626`*^9, 
  3.9040128776617513`*^9}},ExpressionUUID->"62a32e36-c005-486a-9964-\
6191eb260e61"]
},
WindowSize->{701.5, 721.},
WindowMargins->{{Automatic, 12.5}, {Automatic, 3}},
FrontEndVersion->"13.2 for Microsoft Windows (64-bit) (January 30, 2023)",
StyleDefinitions->"Default.nb",
ExpressionUUID->"fa279a33-0442-400d-b6fd-3eab6b480b15"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[558, 20, 4749, 129, 394, "Text",ExpressionUUID->"82180e06-fd4d-4c7d-9a35-692622d2af33"],
Cell[5310, 151, 3087, 84, 134, "Input",ExpressionUUID->"f709db59-644d-46b1-9390-c93ac5c9cb4c"],
Cell[8400, 237, 293, 4, 35, "Text",ExpressionUUID->"f0513101-83d3-439f-8bab-ef380286ecdc"],
Cell[CellGroupData[{
Cell[8718, 245, 2113, 45, 86, "Input",ExpressionUUID->"4bcf5699-246b-4407-a012-fa42f83d9e93"],
Cell[10834, 292, 1782, 47, 80, "Output",ExpressionUUID->"0568c3db-3595-44d9-bc92-d1ddb4880b68"]
}, Open  ]],
Cell[12631, 342, 1200, 28, 86, "Text",ExpressionUUID->"c538d92f-4980-44e9-9cc1-2f63826e0569"],
Cell[CellGroupData[{
Cell[13856, 374, 1547, 48, 74, "Input",ExpressionUUID->"96f82651-58d8-4050-8cea-7e5a19e465ca"],
Cell[15406, 424, 1322, 43, 61, "Output",ExpressionUUID->"425ff5c3-c020-4357-9a3c-d01afc4fa112"]
}, Open  ]],
Cell[16743, 470, 265, 6, 58, "Text",ExpressionUUID->"4d0bd073-b434-4bc3-be11-6749ea372c2b"],
Cell[CellGroupData[{
Cell[17033, 480, 498, 12, 31, "Input",ExpressionUUID->"d61f5898-1609-43d8-af28-189cb9d95e73"],
Cell[17534, 494, 670, 18, 56, "Output",ExpressionUUID->"6c0f0c31-c573-4576-998f-568058620d97"]
}, Open  ]],
Cell[18219, 515, 787, 16, 104, "Text",ExpressionUUID->"d5705be0-4844-4a4e-a7fb-6ea238ba3880"],
Cell[19009, 533, 1201, 32, 67, "Input",ExpressionUUID->"362c6f00-edcd-4b29-a823-2c7020815984"],
Cell[20213, 567, 954, 24, 86, "Input",ExpressionUUID->"73b01958-8c1f-4508-87d1-11ecc34a002f"],
Cell[CellGroupData[{
Cell[21192, 595, 400, 8, 28, "Input",ExpressionUUID->"956468ae-d3b0-4b3e-92b2-01ac3aa70a80"],
Cell[21595, 605, 1403, 45, 61, "Output",ExpressionUUID->"ea3261b0-4c97-4295-b6f2-d83971a6c275"]
}, Open  ]],
Cell[23013, 653, 156, 3, 28, "Input",ExpressionUUID->"62a32e36-c005-486a-9964-6191eb260e61"]
}
]
*)

